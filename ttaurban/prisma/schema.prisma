// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User model - Citizens, Officers, and Admins
model User {
  id                Int         @id @default(autoincrement())
  name              String
  email             String      @unique
  password          String
  phone             String?
  role              UserRole    @default(CITIZEN)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  complaints        Complaint[] @relation("UserComplaints")
  assignedComplaints Complaint[] @relation("AssignedOfficer")
  feedback          Feedback[]
  notifications     Notification[]
  
  @@index([email])
  @@index([role])
  @@map("users")
}

// Department model
model Department {
  id          Int         @id @default(autoincrement())
  name        String      @unique
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // Relations
  complaints  Complaint[]
  
  @@index([name])
  @@map("departments")
}

// Complaint model - Core entity
model Complaint {
  id              Int              @id @default(autoincrement())
  title           String
  description     String
  category        ComplaintCategory
  status          ComplaintStatus  @default(SUBMITTED)
  priority        Priority         @default(MEDIUM)
  latitude        Float?
  longitude       Float?
  address         String?
  imageUrl        String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  resolvedAt      DateTime?
  
  // Foreign Keys
  userId          Int
  departmentId    Int?
  assignedTo      Int?
  
  // Relations
  user            User             @relation("UserComplaints", fields: [userId], references: [id], onDelete: Cascade)
  department      Department?      @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  officer         User?            @relation("AssignedOfficer", fields: [assignedTo], references: [id], onDelete: SetNull)
  auditLogs       AuditLog[]
  feedback        Feedback?
  escalations     Escalation[]
  
  @@index([userId])
  @@index([status])
  @@index([category])
  @@index([departmentId])
  @@index([assignedTo])
  @@index([createdAt])
  @@map("complaints")
}

// AuditLog model - Tracks complaint lifecycle
model AuditLog {
  id            Int              @id @default(autoincrement())
  complaintId   Int
  previousStatus ComplaintStatus?
  newStatus     ComplaintStatus
  comment       String?
  changedBy     String
  createdAt     DateTime         @default(now())
  
  // Relations
  complaint     Complaint        @relation(fields: [complaintId], references: [id], onDelete: Cascade)
  
  @@index([complaintId])
  @@index([createdAt])
  @@map("audit_logs")
}

// Feedback model - Citizen ratings and comments
model Feedback {
  id            Int       @id @default(autoincrement())
  complaintId   Int       @unique
  userId        Int
  rating        Int       // 1-5 stars
  comment       String?
  createdAt     DateTime  @default(now())
  
  // Relations
  complaint     Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([rating])
  @@index([createdAt])
  @@map("feedbacks")
}

// Escalation model - SLA-based escalations
model Escalation {
  id            Int       @id @default(autoincrement())
  complaintId   Int
  reason        String
  escalatedAt   DateTime  @default(now())
  resolvedAt    DateTime?
  
  // Relations
  complaint     Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade)
  
  @@index([complaintId])
  @@index([escalatedAt])
  @@map("escalations")
}

// Notification model
model Notification {
  id          Int       @id @default(autoincrement())
  userId      Int
  title       String
  message     String
  isRead      Boolean   @default(false)
  createdAt   DateTime  @default(now())
  
  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// Enums
enum UserRole {
  CITIZEN
  OFFICER
  ADMIN
}

enum ComplaintCategory {
  ROAD_MAINTENANCE
  WATER_SUPPLY
  ELECTRICITY
  GARBAGE_COLLECTION
  STREET_LIGHTS
  DRAINAGE
  PUBLIC_SAFETY
  OTHER
}

enum ComplaintStatus {
  SUBMITTED
  VERIFIED
  ASSIGNED
  IN_PROGRESS
  RESOLVED
  CLOSED
  REJECTED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}
